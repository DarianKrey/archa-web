<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archa | The Aegean Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream: #fdfbf7;
            --charcoal: #1a1a1a;
            --border: #eceae6;
            --aegean: #0c2d48;
            --aegean-light: #1a4d6f;
            --serif: 'Cormorant Garamond', Georgia, serif;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--cream); color: var(--charcoal); margin: 0; min-height: 100vh; padding-bottom: 60px; }
        .header {
            position: relative;
            width: 100%;
            min-height: 50vh;
            background: var(--aegean) url('https://i.imgur.com/9XGR5u9.jpeg') center / cover no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.35) 100%);
            pointer-events: none;
        }
        .header .hero-title {
            position: relative;
            z-index: 1;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(4rem, 18vw, 11rem);
            font-weight: 400;
            letter-spacing: 0.02em;
            color: #fff;
            text-shadow: 0 2px 20px rgba(0,0,0,0.4);
            margin: 0;
            line-height: 0.95;
        }
        .recent-adventures {
            max-width: 1100px;
            margin: -28px auto 0;
            padding: 32px 24px;
            position: relative;
            z-index: 1;
            text-align: center;
        }
        .recent-adventures .category-heading {
            font-family: var(--serif);
            font-size: clamp(1.5rem, 4vw, 2.25rem);
            font-weight: 400;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--aegean);
            margin: 0 0 18px;
        }
        .recent-adventures .category-heading:last-child {
            margin-bottom: 0;
        }
        .recent-adventures .category-heading a {
            color: inherit;
            text-decoration: none;
        }
        .recent-adventures .category-heading a:hover {
            text-decoration: underline;
        }
        .container-wrap { display: flex; justify-content: center; padding: 40px 24px 0; }
        .container { max-width: 450px; width: 100%; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 20px 40px rgba(0,0,0,0.06); text-align: center; }
        h1:not(.header h1) { font-family: var(--serif); font-size: 2.5rem; margin-bottom: 10px; font-weight: 400; letter-spacing: -1px; }
        .container p { color: #666; line-height: 1.6; margin-bottom: 30px; font-size: 0.95rem; }
        .form-section { text-align: left; margin-bottom: 25px; }
        label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; color: #999; display: block; margin-bottom: 8px; font-weight: 700; }
        input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-size: 1rem; margin-bottom: 15px; background: #fafafa; }
        .btn { width: 100%; padding: 18px; border-radius: 4px; cursor: pointer; letter-spacing: 2px; font-weight: 600; font-size: 0.85rem; transition: all 0.2s ease; border: none; margin-bottom: 10px; }
        #picker-button { background: var(--aegean); color: var(--cream); }
        #submit-btn {
            margin-top: 25px;
            background: var(--aegean);
            color: var(--cream);
            box-shadow: 0 2px 8px rgba(12, 45, 72, 0.25);
        }
        #submit-btn:hover {
            background: var(--aegean-light);
            box-shadow: 0 4px 16px rgba(12, 45, 72, 0.35);
            transform: translateY(-1px);
        }
        #submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(12, 45, 72, 0.3);
        }
        #submit-btn:focus-visible {
            outline: 2px solid var(--aegean);
            outline-offset: 2px;
        }
        .upload-area { border: 2px dashed var(--border); padding: 20px; border-radius: 4px; background: #fafafa; cursor: pointer; }
        .upload-area p { margin: 0; font-size: 0.8rem; color: #888; }
        #file-input { display: none; }
        .divider { margin: 20px 0; font-size: 0.7rem; color: #ccc; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: var(--border); margin: 0 10px; }
        #preview-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 15px; justify-content: center; }
        .preview-img { width: 50px; height: 50px; object-fit: cover; border-radius: 2px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header class="header">
    <h1 class="hero-title">ARCHA</h1>
</header>

<section class="recent-adventures">
    <h2 class="category-heading"><a href="weddings.html">Weddings</a></h2>
    <h2 class="category-heading"><a href="travel.html">Travel</a></h2>
    <h2 class="category-heading"><a href="forever.html">Forever</a></h2>
</section>

<div class="container-wrap">
<div class="container" id="main-content">
    <h1>Begin Your Archive</h1>
    <p id="sub-header">Curating your finest moments into a timeless physical archive.</p>

    <form name="archa-alpha-onboarding" method="POST" data-netlify="true" id="onboarding-form" enctype="multipart/form-data" action="/">
        <div class="form-section">
            <label>Full Name</label>
            <input type="text" name="name" id="user-name" placeholder="Darian Allberry" required>
            <label>Email Address</label>
            <input type="email" name="email" id="user-email" placeholder="darian@example.com" required>
        </div>

        <button type="button" id="picker-button" class="btn">ACCESS GOOGLE PHOTOS</button>
        <div class="divider">or</div>
        <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <p>UPLOAD FROM DEVICE</p>
            <input type="file" name="manual-photos" id="file-input" multiple accept="image/*">
            <div id="preview-container"></div>
        </div>

        <button type="submit" id="submit-btn" class="btn">SUBMIT ARCHIVE</button>
    </form>
</div>
</div>

<script src="https://accounts.google.com/gsi/client"></script>
<script>
    // Google Photos: use the NEW Picker API (REST sessions). The old JS Picker (ViewId.PHOTOS) often returns 403.
    // In Cloud Console: enable "Google Photos Picker API", add your site origin to OAuth "Authorized JavaScript origins"
    // (e.g. https://yoursite.netlify.app and http://localhost:3000), and if testing, add your email as a test user.
    const CLIENT_ID = '395230076534-7p1jg57bplj9j74e1adk2uu0r9n4qujv.apps.googleusercontent.com';
    const PICKER_API = 'https://photospicker.googleapis.com/v1';

    let tokenClient;

    window.onload = () => {
        if (window.location.protocol === 'file:') {
            console.warn('This page is open from file://. Form submit and Google sign-in will fail. Run a local server (e.g. npx serve .) or deploy to Netlify.');
        }
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/photospicker.mediaitems.readonly',
            callback: (resp) => {
                if (resp.error) {
                    console.error('Google sign-in error:', resp);
                    alert('Sign-in failed: ' + (resp.error_description || resp.error || 'Unknown error') + '. Try deploying this page to Netlify or running a local server—file:// pages often fail.');
                    return;
                }
                openPhotosPicker(resp.access_token);
            },
        });
    };

    function parseDuration(s) {
        if (!s || typeof s !== 'string') return 0;
        const match = s.match(/^([\d.]+)s$/);
        return match ? parseFloat(match[1]) * 1000 : 2000;
    }

    function openPhotosPicker(accessToken) {
        fetch(PICKER_API + '/sessions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + accessToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(r => {
            if (!r.ok) return r.json().then(j => Promise.reject(new Error(j.error?.message || 'Session create failed ' + r.status)));
            return r.json();
        })
        .then(session => {
            const pickerUri = session.pickerUri + (session.pickerUri.indexOf('/autoclose') === -1 ? '/autoclose' : '');
            const sessionId = session.id;
            const pollInterval = parseDuration(session.pollingConfig?.pollInterval) || 2000;
            const timeoutIn = parseDuration(session.pollingConfig?.timeoutIn) || 300000;

            window.open(pickerUri, 'photos-picker', 'width=800,height=600');

            const start = Date.now();
            function poll() {
                if (Date.now() - start > timeoutIn) {
                    return;
                }
                fetch(PICKER_API + '/sessions/' + sessionId, {
                    headers: { 'Authorization': 'Bearer ' + accessToken },
                })
                .then(r => r.json())
                .then(data => {
                    if (data.mediaItemsSet) {
                        fetch(PICKER_API + '/sessions/' + sessionId, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + accessToken } }).catch(() => {});
                        fetchPickedMediaItems(accessToken, sessionId).then(handleSuccess);
                        return;
                    }
                    setTimeout(poll, pollInterval);
                })
                .catch(err => {
                    console.error('Picker poll error:', err);
                    setTimeout(poll, pollInterval);
                });
            }
            setTimeout(poll, pollInterval);
        })
        .catch(err => {
            console.error('Photos Picker error:', err);
            alert('Could not open Google Photos. If you see 403: enable "Google Photos Picker API" in Google Cloud Console and add this site’s URL to Authorized JavaScript origins.');
        });
    }

    function fetchPickedMediaItems(accessToken, sessionId) {
        const all = [];
        function fetchPage(pageToken) {
            const url = PICKER_API + '/mediaItems?sessionId=' + encodeURIComponent(sessionId) + (pageToken ? '&pageToken=' + encodeURIComponent(pageToken) : '') + '&pageSize=100';
            return fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } })
                .then(r => r.json())
                .then(data => {
                    if (data.mediaItems) all.push(...data.mediaItems);
                    if (data.nextPageToken) return fetchPage(data.nextPageToken);
                    return all;
                });
        }
        return fetchPage();
    }

    function handleSuccess(pickedItems = []) {
        document.getElementById('onboarding-form').classList.add('hidden');
        const count = pickedItems.length;
        document.getElementById('sub-header').innerText = count
            ? count + " photo" + (count !== 1 ? "s" : "") + " linked. Our curators will reach out to you within 24 hours."
            : "Archive linked. Our curators will reach out to you within 24 hours.";
        const form = document.getElementById('onboarding-form');
        const formData = new FormData(form);
        formData.append('form-name', 'archa-alpha-onboarding');
        if (pickedItems.length) {
            formData.append('google-photos-count', String(pickedItems.length));
            const items = pickedItems.map(item => {
                const mediaFile = item.mediaFile || item.media_file || {};
                const baseUrl = mediaFile.baseUrl || mediaFile.base_url || '';
                return {
                    id: item.id,
                    baseUrl: baseUrl,
                    mimeType: mediaFile.mimeType || mediaFile.mime_type || ''
                };
            });
            formData.append('google-photos-items', JSON.stringify(items));
            const viewUrls = items.map(i => i.baseUrl ? i.baseUrl + '=w800' : '').filter(Boolean);
            viewUrls.forEach((url, i) => {
                formData.append('photo-link-' + (i + 1), url);
            });
            if (viewUrls.length) formData.append('all-photo-links', viewUrls.join(' '));
        }
        const action = form.getAttribute('action') || '/';
        fetch(action, {
            method: "POST",
            body: formData,
        })
        .then(() => { /* success */ })
        .catch(err => {
            console.error('Submit failed:', err);
            document.getElementById('sub-header').innerText = "Archive linked. If this page didn’t redirect, submit again once the site is live on Netlify.";
        });
    }

    document.getElementById('picker-button').addEventListener('click', () => {
        if (!document.getElementById('user-name').value) return alert("Enter your name first.");
        tokenClient.requestAccessToken({prompt: 'consent'});
    });

    document.getElementById('file-input').addEventListener('change', function(e) {
        const preview = document.getElementById('preview-container');
        preview.innerHTML = '';
        Array.from(this.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.className = 'preview-img';
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    });
</script>

</body>
</html>